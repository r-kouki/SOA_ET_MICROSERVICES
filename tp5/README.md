# TP5: gRPC Chat Service with WebSocket Reverse Proxy

This project implements a simplified chat service using gRPC for the core logic and a WebSocket reverse proxy to allow web clients to connect.
It includes a basic message history feature and a simple web client.

## Project Structure

```
tp5/
├── grpc-ws-reverse-proxy/
│   ├── chat.proto          # gRPC service and message definitions
│   ├── server.js           # Node.js gRPC server implementation
│   ├── proxy.js            # Node.js WebSocket reverse proxy
│   ├── client.html         # Simple web client for testing
│   └── package.json        # Project dependencies
│   └── package-lock.json
└── README.md             # This file
```

## Prerequisites

*   Node.js and npm installed.

## Setup

1.  Navigate to the project's sub-directory:
    ```bash
    cd tp5/grpc-ws-reverse-proxy
    ```
2.  Install dependencies (if not already done by the setup script):
    ```bash
    npm install
    ```

## Running the Application

You will need two separate terminals to run the gRPC server and the WebSocket proxy.

**1. Start the gRPC Server:**

*   In the `tp5/grpc-ws-reverse-proxy` directory, run:
    ```bash
    node server.js
    ```
*   You should see a message like: `Serveur gRPC en écoute sur 0.0.0.0:50051`

**2. Start the WebSocket Reverse Proxy:**

*   In another terminal, also in the `tp5/grpc-ws-reverse-proxy` directory, run:
    ```bash
    node proxy.js
    ```
*   You should see a message like: `Reverse proxy WebSocket en écoute sur ws://localhost:8080`

## Testing

### Using the Web Client

1.  Once both the gRPC server and WebSocket proxy are running, open the `client.html` file in your web browser.
    *   You can usually do this by right-clicking the file in your file explorer and choosing "Open with Browser" or by navigating to `file:///path/to/your/project/tp5/grpc-ws-reverse-proxy/client.html`.
2.  The client will attempt to connect to `ws://localhost:8080`.
3.  You can set a "Room ID" and your "User ID" (a random one is generated by default).
4.  Type a message and click "Send". Your message will be sent to the gRPC server via the WebSocket proxy, and an echo response from the server (modified by `server.js`) will appear in the chat window.
5.  Click "Load History" to fetch and display messages previously sent in the current server session.

### Using Postman (for WebSocket testing, as per PDF)

1.  Open Postman.
2.  Create a new WebSocket request.
3.  Set the URL to `ws://localhost:8080`.
4.  Connect to the WebSocket server.
5.  Send a JSON message respecting the `ChatMessage` schema defined in `chat.proto`. For example:
    ```json
    {
      "id": "msg1",
      "room_id": "room1",
      "sender_id": "postman_client",
      "content": "Hello World from Postman!"
    }
    ```
    The proxy will wrap this in `{ "chat_message": ... }` if it's not already in that format before sending to gRPC.
6.  You should receive an echo message back from the server.
7.  To test history, send:
    ```json
    {
        "action": "getHistory"
    }
    ```
    You will receive a message with `"type": "history"` and the array of messages in `"data"`.

## Functionality Overview

*   **`chat.proto`**: Defines the gRPC service `ChatService` with methods:
    *   `GetUser`: Retrieves a dummy user.
    *   `Chat`: Bidirectional streaming RPC for sending and receiving chat messages.
The server echoes back messages with a timestamp.
    *   `GetChatHistory`: Retrieves all messages stored in memory for the current session.
*   **`server.js`**: Implements the gRPC `ChatService`. It stores chat messages in an in-memory array for the history feature.
*   **`proxy.js`**: Listens for WebSocket connections on port 8080. For each connected client:
    *   It establishes a gRPC `Chat` stream with `server.js`.
    *   Messages from the WebSocket client are relayed to the gRPC server.
    *   Messages from the gRPC server (echoes) are relayed back to the WebSocket client.
    *   Handles a special `{"action": "getHistory"}` message from the WebSocket client to call the `GetChatHistory` gRPC method and return the history.
*   **`client.html`**: A basic web interface to interact with the chat, send messages, and request message history. 